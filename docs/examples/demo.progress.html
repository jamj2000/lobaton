<!DOCTYPE html>
<html lang="es">
   <meta charset="UTF-8">
   <title>Demonstración mínima</title>
   <!-- Leaflet -->
   <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
         integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
          crossorigin="">
   <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
           integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
           crossorigin=""></script>
   <!-- Plugin: Marcas agrupables -->
   <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
   <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
   <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">
   <!-- Extensión para el soporte de iconos mutables -->
   <script src="../../dist/leafext.js"></script>
   <link rel="stylesheet" href="../dist/images/chupachups.css">
   <script>
      function* genCentros(num) {
         const ii = [36.623794, -7.234497],
               sd = [38.159936, -2.362061];

         function random(a, b) { return a + Math.random()*(b-a); }
         function hasta(n) { return Math.floor(Math.random()*n);}

         const tipos = new Array(13).fill("normal");
         tipos.push("dificil");
         tipos.push("compensatoria");
         const ens = ["SMR", "ASIR", "DAM", "DAW", "Bachillerato"];
         const adj = ["Suprimido", "Desplazado", "Salud", "Concursillo", "Prácticas", "Interino"];

         for(let i=0; i<num; i++) {
            yield {
               type: "Feature",
               geometry: {
                  type: "Point",
                  coordinates: [random(ii[1], sd[1]), random(ii[0], sd[0])]
               },
               properties: {
                  name: "Centro " + i,
                  tipo: tipos[hasta(tipos.length)],
                  oferta: new Array(hasta(6)).fill(null).map(e => ens[hasta(ens.length)]),
                  adj: new Array(hasta(8)).fill(null).map(e => adj[hasta(adj.length)])
               }
            }
         }
      }

      function init() {
         const Icono = crearIcono();

         const Centro = L.Marker.extend({
            options: {mutable: "feature.properties"}
         });   

         map = L.map("map").setView([37.07, -6.27], 9);
         L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
             maxZoom: 18
         }).addTo(map);

         const layer = L.markerClusterGroup({
            showCoverageOnHover: false,
            // Al llegar a nivel 14 de zoom se ven todas las marcas.
            disableClusteringAtZoom: 14,
            spiderfyOnMaxZoom: false
         }).addTo(map);

         function addData(data, cluster, chunkInterval, chunkDelay, chunkProgress) {
            const  ini = Date.now();
            var offset = 0;

            // Y una capa GeoJSON para crear las marcas y conectarles los datos.
            const interm =  L.geoJSON(undefined, {
               pointToLayer: (f, p) => new Centro(p, {
                  icon: new Icono(),
                  title: f.properties.name
               }),
               onEachFeature: (f, l) => cluster.addLayer(l)
            });

            function loop() {
               const start = Date.now();
               let c;
               while(c = data.next()) {
                  if(c.done) break;
                  offset++;
                  interm.addData(c.value);
                  if(offset%200 === 0 && Date.now() - start > chunkInterval) break;
               }
               if(chunkProgress) chunkProgress(offset, Date.now() - ini);
               if(!c.done) setTimeout(loop, chunkDelay);
            }
            loop();
         }

         const num = 20000;

         function barra(idx, elapsed) {
            console.log("DEBUG", `Llevamos el ${idx*100/num}%`);
         }

         addData(genCentros(num), layer, 200, 50, barra);
      }

      function crearIcono() {
         const converter = new L.utils.Converter(["numadj", "tipo"])
                              .define("numadj", "adj", a => a.length)
                              .define("tipo");

         function updater(o) {
            const content = this.querySelector(".content");
            if(o.tipo) content.className = "content " + o.tipo;
            if(o.numadj !== undefined) content.firstElementChild.textContent = o.numadj;
            return this;
         }

         return L.utils.createMutableIconClass("chupachups", {
            iconSize: [25, 34],
            iconAnchor: [12.5, 34],
            html: document.querySelector("template").content,
            css: "icons/chupachups.css",
            converter: converter,
            updater: updater
         });
      }

      window.onload = init;
   </script>

   <style>
      /*<![CDATA[*/
      html, body {
         width: 100%;
         height: 100%;
         margin: 0; padding: 0;
      }
      #map {
         width: 100%;
         height: 100%;
      }
      /*]]>*/
   </style>

   <div id="map"></div>
   <template>
      <div class="content"><span></span></div>
      <div class="arrow"></div>
   </template>
</html>
